<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSphere | Message</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .message-enter {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator {
            animation: pulse 1.5s infinite;
        }

        .message-bubble {
            transition: all 0.2s ease;
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .active-link {
            background-image: linear-gradient(to right, #2563EB, #8B5CF6);
            color: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }

        .conversation-active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #2563EB;
        }

        .conversation-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 flex dark:bg-gray-900 transition-all duration-500">
<!-- Wrapper -->
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 min-h-screen transition duration-300 ease-in-out bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-r border-slate-200/50 dark:border-slate-700/50 flex flex-col relative z-10">
            <div class="p-5 border-b border-slate-200/50 dark:border-slate-700/50">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i data-lucide="school" class="w-6 h-6 font-medium text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 dark:text-white">EduSphere</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Smart Classroom</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a
                        href="index.html"
                        data-page="index"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group"
                >
                    <i
                            data-lucide="home"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Dashboard</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>

                </a>
                <a
                        href="teacher.html"
                        data-page="teacher"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="users"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Teachers</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
                <a
                        href="../manageStudent.html"
                        data-page="student"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="users"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Students</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
                <a
                        href="../manageClassroom.html"
                        data-page="classroom"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="landmark"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Classrooms</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
                <a
                        href="#"
                        data-page="materials"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="package"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Materials</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
                <a
                        href="#"
                        data-page="messages"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="message-square"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Messages</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
                <a
                        href="../profile.html"
                        data-page="profile"
                        class="w-full text-slate-700 dark:text-slate-200 flex items-center gap-3 px-4 py-2 mb-3 rounded-xl text-left group dark:hover:bg-gray-800 hover:bg-gray-100 hover:shadow"
                >
                    <i
                            data-lucide="user-circle"
                            class="w-5 h-5 transition-all duration-200"
                    ></i>
                    <span class="font-medium">Profile</span>
                    <i data-lucide="dot" class="ml-auto w-6 h-6 text-amber-200 rounded-full animate-pulse hidden"></i>
                </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-slate-200/50 dark:border-slate-700/50">
                <div
                        class="flex items-center space-x-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50"
                >
                    <img
                            src="../Assets/images/user-profile-male.avif"
                            alt="user"
                            class="w-10 h-10 rounded-full ring-2 ring-blue-500"
                    />
                    <div class="flex-1 min-w-0">
                        <p
                                class="text-sm font-medium text-slate-800 dark:text-white truncate"
                        >
                            Mirzan Musawwir
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 truncate">
                            Administrator
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200/50 dark:border-slate-700/50 px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Header Left -->
                    <div class="flex items-center space-x-4">
                        <button class="p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                        </button>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                                <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 id="currentConversationTitle" class="text-xl font-black text-slate-800 dark:text-slate-100">Mathematics - Grade 10</h1>
                                <p class="text-slate-600 dark:text-slate-300 flex items-center">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                    24 members online
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Header Right -->
                    <div class="flex items-center space-x-3">
                        <button class="p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                            <i data-lucide="video" class="w-5 h-5"></i>
                        </button>
                        <button class="p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                            <i data-lucide="phone" class="w-5 h-5"></i>
                        </button>
                        <button class="p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="flex-1 px-6 py-4 overflow-y-auto bg-gray-50 dark:bg-gray-900">
                <!-- Conversations List -->
                <div class="p-4">
                    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center">
                        <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>
                        Recent Conversations
                    </h3>
                    <div id="conversationsList" class="space-y-2">
                        <!-- Conversations will be loaded here -->
                    </div>
                    <button id="newConversationBtn" class="w-full mt-3 flex items-center justify-center gap-2 px-4 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        New Conversation
                    </button>
                </div>
                <div class="max-w-4xl mx-auto">
                    <!-- Messages Container -->
                    <div id="messagesContainer" class="space-y-4 pb-4">
                        <!-- Welcome message will be shown when no conversation is selected -->
                        <div id="welcomeMessage" class="flex flex-col items-center justify-center h-full py-12">
                            <div class="w-24 h-24 bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/20 dark:to-purple-900/20 rounded-full flex items-center justify-center mb-6">
                                <i data-lucide="message-circle" class="w-12 h-12 text-blue-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Welcome to EduSphere Chat</h2>
                            <p class="text-gray-600 dark:text-gray-400 text-center max-w-md mb-6">Select a conversation from the sidebar or start a new one to begin chatting with your AI assistant.</p>
                            <button id="startConversationBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Start New Conversation
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="px-6 py-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-t border-slate-200/50 dark:border-slate-700/50 hidden" id="inputArea">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4 shadow-lg">
                        <form id="messageForm" class="flex items-end space-x-3">
                            <button type="button" class="p-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                <i data-lucide="paperclip" class="w-5 h-5"></i>
                            </button>

                            <div class="flex-1 relative">
                                    <textarea
                                            id="messageInput"
                                            placeholder="Ask a question or share your thoughts..."
                                            class="w-full resize-none border-none focus:outline-none bg-transparent text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 max-h-32"
                                            rows="1"
                                    ></textarea>
                            </div>

                            <button type="button" class="p-2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                                <i data-lucide="smile" class="w-5 h-5"></i>
                            </button>

                            <button
                                    type="submit"
                                    id="sendButton"
                                    class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-2 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>

                        <!-- Quick Actions -->
                        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Quick actions:</span>
                            <button class="inline-flex items-center gap-1 px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i data-lucide="help-circle" class="w-3 h-3"></i>
                                Help
                            </button>
                            <button class="inline-flex items-center gap-1 px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i data-lucide="calculator" class="w-3 h-3"></i>
                                Formula
                            </button>
                            <button class="inline-flex items-center gap-1 px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                <i data-lucide="book-open" class="w-3 h-3"></i>
                                Examples
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Conversation model and data
    const conversationsModel = {
        currentConversationId: null,
        conversations: [],

        // Initialize with sample data
        init: function() {
            // Try to load from localStorage
            const savedConversations = localStorage.getItem('edusphere_conversations');

            if (savedConversations) {
                this.conversations = JSON.parse(savedConversations);
            } else {
                // Create sample conversations
                this.conversations = [
                    {
                        id: '1',
                        title: 'Quadratic Equations Help',
                        subject: 'Mathematics',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                        messages: [
                            {
                                id: '1-1',
                                sender: 'ai',
                                text: 'Hello! I\'m here to help you with your mathematics questions. How can I assist you today?',
                                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
                            },
                            {
                                id: '1-2',
                                sender: 'user',
                                text: 'Can you help me understand quadratic equations? I\'m having trouble with the vertex form.',
                                timestamp: new Date(Date.now() - 119 * 60 * 1000).toISOString()
                            },
                            {
                                id: '1-3',
                                sender: 'ai',
                                text: 'Of course! The vertex form of a quadratic equation is y = a(x - h)² + k, where (h, k) represents the vertex of the parabola. Let me break this down for you:\n\nKey components:\n• a: determines the width and direction of the parabola\n• h: x-coordinate of the vertex\n• k: y-coordinate of the vertex',
                                timestamp: new Date(Date.now() - 118 * 60 * 1000).toISOString()
                            }
                        ]
                    },
                    {
                        id: '2',
                        title: 'Geometry Proofs',
                        subject: 'Mathematics',
                        timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                        messages: [
                            {
                                id: '2-1',
                                sender: 'ai',
                                text: 'Hello! How can I help with geometry today?',
                                timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
                            },
                            {
                                id: '2-2',
                                sender: 'user',
                                text: 'I need help understanding triangle congruence proofs.',
                                timestamp: new Date(Date.now() - 23.5 * 60 * 60 * 1000).toISOString()
                            }
                        ]
                    },
                    {
                        id: '3',
                        title: 'Chemistry Questions',
                        subject: 'Science',
                        timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        messages: [
                            {
                                id: '3-1',
                                sender: 'ai',
                                text: 'Hello! I\'m here to help with your chemistry questions.',
                                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                            }
                        ]
                    }
                ];
                this.saveToLocalStorage();
            }

            return this;
        },

        // Get all conversations
        getAll: function() {
            return this.conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        // Get a specific conversation
        get: function(id) {
            return this.conversations.find(conv => conv.id === id);
        },

        // Create a new conversation
        create: function(subject = 'General') {
            const newId = Date.now().toString();
            const newConversation = {
                id: newId,
                title: 'New Conversation',
                subject: subject,
                timestamp: new Date().toISOString(),
                messages: [
                    {
                        id: `${newId}-1`,
                        sender: 'ai',
                        text: 'Hello! How can I help you with your studies today?',
                        timestamp: new Date().toISOString()
                    }
                ]
            };

            this.conversations.unshift(newConversation);
            this.saveToLocalStorage();

            return newId;
        },

        // Add a message to a conversation
        addMessage: function(conversationId, sender, text) {
            const conversation = this.get(conversationId);
            if (!conversation) return false;

            const newMessage = {
                id: `${conversationId}-${conversation.messages.length + 1}`,
                sender: sender,
                text: text,
                timestamp: new Date().toISOString()
            };

            conversation.messages.push(newMessage);
            conversation.timestamp = new Date().toISOString();
            this.saveToLocalStorage();

            return true;
        },

        // Update conversation title
        updateTitle: function(conversationId, title) {
            const conversation = this.get(conversationId);
            if (!conversation) return false;

            conversation.title = title;
            this.saveToLocalStorage();

            return true;
        },

        // Save to localStorage
        saveToLocalStorage: function() {
            localStorage.setItem('edusphere_conversations', JSON.stringify(this.conversations));
        }
    };

    // UI Controller
    const appController = {
        init: function() {
            this.conversationsModel = conversationsModel.init();
            this.loadConversationsList();
            this.bindEvents();
        },

        // Load conversations into the sidebar
        loadConversationsList: function() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '';

            const conversations = this.conversationsModel.getAll();

            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                        <i data-lucide="message-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">No conversations yet</p>
                    </div>
                `;
                return;
            }

            conversations.forEach(conversation => {
                const conversationEl = document.createElement('div');
                conversationEl.className = 'conversation-item p-3 rounded-lg cursor-pointer transition-colors';
                conversationEl.dataset.id = conversation.id;

                // Get the last message preview
                const lastMessage = conversation.messages[conversation.messages.length - 1];
                const preview = lastMessage.text.length > 30 ?
                    lastMessage.text.substring(0, 30) + '...' : lastMessage.text;

                // Format time
                const time = new Date(conversation.timestamp).toLocaleTimeString([], {
                    hour: '2-digit', minute: '2-digit'
                });

                conversationEl.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-slate-800 dark:text-slate-200 truncate">${conversation.title}</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate">${preview}</p>
                        </div>
                        <span class="text-xs text-slate-400 dark:text-slate-500 ml-2">${time}</span>
                    </div>
                    <div class="mt-1 flex items-center">
                        <span class="inline-block px-2 py-0.5 text-xs bg-${this.getSubjectColor(conversation.subject)}-100 dark:bg-${this.getSubjectColor(conversation.subject)}-900/20 text-${this.getSubjectColor(conversation.subject)}-800 dark:text-${this.getSubjectColor(conversation.subject)}-200 rounded-full">
                            ${conversation.subject}
                        </span>
                    </div>
                `;

                conversationsList.appendChild(conversationEl);

                // Add click event
                conversationEl.addEventListener('click', () => {
                    this.loadConversation(conversation.id);
                });
            });

            // Re-initialize Lucide icons
            lucide.createIcons();
        },

        // Get color based on subject
        getSubjectColor: function(subject) {
            const colorMap = {
                'Mathematics': 'blue',
                'Science': 'green',
                'English': 'purple',
                'History': 'amber',
                'General': 'gray'
            };

            return colorMap[subject] || 'gray';
        },

        // Load a specific conversation
        loadConversation: function(conversationId) {
            const conversation = this.conversationsModel.get(conversationId);
            if (!conversation) return;

            // Update UI to show this is the active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('conversation-active');
            });

            document.querySelector(`.conversation-item[data-id="${conversationId}"]`).classList.add('conversation-active');

            // Update header
            document.getElementById('currentConversationTitle').textContent = conversation.title;

            // Show input area
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('welcomeMessage').classList.add('hidden');

            // Clear messages container
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            // Add welcome message with conversation start time
            const startTime = new Date(conversation.timestamp).toLocaleTimeString([], {
                hour: '2-digit', minute: '2-digit'
            });

            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'flex justify-center mb-6';
            welcomeDiv.innerHTML = `
                <div class="bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm px-4 py-2 rounded-full text-sm text-gray-600 dark:text-gray-300 shadow-sm">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>
                    Conversation started at ${startTime}
                </div>
            `;
            messagesContainer.appendChild(welcomeDiv);

            // Add all messages
            conversation.messages.forEach(message => {
                this.addMessageToUI(message, conversationId);
            });

            // Set current conversation
            this.conversationsModel.currentConversationId = conversationId;

            // Scroll to bottom
            this.scrollToBottom();
        },

        // Add a message to the UI
        addMessageToUI: function(message, conversationId) {
            const messagesContainer = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 message-enter ${message.sender === 'user' ? 'justify-end' : ''}`;

            const time = new Date(message.timestamp).toLocaleTimeString([], {
                hour: '2-digit', minute: '2-digit'
            });

            if (message.sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1 text-right">
                        <div class="flex items-center justify-end space-x-2 mb-1">
                            <span class="text-xs text-gray-500 dark:text-gray-400">${time}</span>
                            <span class="text-sm font-semibold text-gray-800 dark:text-white">You</span>
                        </div>
                        <div class="message-bubble bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl rounded-tr-md px-4 py-3 shadow-sm inline-block">
                            <p class="text-white">${this.escapeHtml(message.text)}</p>
                        </div>
                    </div>
                    <div class="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i data-lucide="user" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-semibold text-gray-800 dark:text-white">AI Assistant</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${time}</span>
                        </div>
                        <div class="message-bubble bg-white dark:bg-gray-800 rounded-2xl rounded-tl-md px-4 py-3 shadow-sm border border-gray-200 dark:border-gray-700">
                            <p class="text-gray-800 dark:text-gray-200">${this.escapeHtml(message.text)}</p>
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);

            // Re-initialize Lucide icons for new elements
            lucide.createIcons();
        },

        // Create a new conversation
        createNewConversation: function() {
            const newId = this.conversationsModel.create('Mathematics');
            this.loadConversationsList();
            this.loadConversation(newId);

            // Set a timeout to update the title based on the first user message
            this.pendingTitleUpdate = true;
        },

        // Bind event listeners
        bindEvents: function() {
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const newConversationBtn = document.getElementById('newConversationBtn');
            const startConversationBtn = document.getElementById('startConversationBtn');

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';

                // Enable/disable send button
                sendButton.disabled = this.value.trim() === '';
            });

            // Handle form submission
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();

                if (message && this.conversationsModel.currentConversationId) {
                    // Add user message
                    this.conversationsModel.addMessage(
                        this.conversationsModel.currentConversationId,
                        'user',
                        message
                    );

                    this.addMessageToUI({
                        sender: 'user',
                        text: message,
                        timestamp: new Date().toISOString()
                    }, this.conversationsModel.currentConversationId);

                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    sendButton.disabled = true;

                    // Update conversation title if it's the first user message
                    if (this.pendingTitleUpdate) {
                        const title = message.length > 20 ? message.substring(0, 20) + '...' : message;
                        this.conversationsModel.updateTitle(this.conversationsModel.currentConversationId, title);
                        this.loadConversationsList();
                        document.getElementById('currentConversationTitle').textContent = title;
                        this.pendingTitleUpdate = false;
                    }

                    // Show typing indicator
                    this.showTypingIndicator();

                    // Simulate AI response
                    setTimeout(() => {
                        this.hideTypingIndicator();

                        const aiResponse = this.generateAIResponse(message);

                        // Add AI message to model
                        this.conversationsModel.addMessage(
                            this.conversationsModel.currentConversationId,
                            'ai',
                            aiResponse
                        );

                        // Add AI message to UI
                        this.addMessageToUI({
                            sender: 'ai',
                            text: aiResponse,
                            timestamp: new Date().toISOString()
                        }, this.conversationsModel.currentConversationId);
                    }, Math.random() * 2000 + 1000);
                }
            });

            // Handle Enter key (but allow Shift+Enter for new lines)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    messageForm.dispatchEvent(new Event('submit'));
                }
            });

            // New conversation buttons
            newConversationBtn.addEventListener('click', () => {
                this.createNewConversation();
            });

            startConversationBtn.addEventListener('click', () => {
                this.createNewConversation();
            });
        },

        // Show typing indicator
        showTypingIndicator: function() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.className = 'flex items-start space-x-3';
            typingIndicator.innerHTML = `
                <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                    <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl rounded-tl-md px-4 py-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;

            document.getElementById('messagesContainer').appendChild(typingIndicator);
            this.scrollToBottom();

            // Re-initialize Lucide icons
            lucide.createIcons();
        },

        // Hide typing indicator
        hideTypingIndicator: function() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        },

        // Scroll to bottom of messages
        scrollToBottom: function() {
            setTimeout(() => {
                const container = document.getElementById('messagesContainer').parentElement;
                container.scrollTop = container.scrollHeight;
            }, 100);
        },

        // Escape HTML to prevent XSS
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        // Generate a simple AI response (in a real app, this would call an API)
        generateAIResponse: function(userMessage) {
            const responses = [
                "I understand your question about " + (userMessage.length > 20 ? userMessage.substring(0, 20) + "..." : userMessage) + ". Let me explain that in more detail.",
                "That's an excellent question! Here's what you need to know about that concept.",
                "I'd be happy to help with that. Let me break it down for you step by step.",
                "Great question! This is an important concept to understand. Here's my explanation.",
                "I see what you're asking about. Let me provide some clarification on that topic."
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        appController.init();
    });
</script>
</body>
</html>